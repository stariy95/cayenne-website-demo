<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="http://cayenne.apache.org/css/styles-b770de6275.css"/>
        <script src="http://cayenne.apache.org/js/bundle-736b99fdc1.js"></script>
        <title>DataObject State Management &middot; Apache Cayenne</title>
    </head>
    <body>
<header class="page-header">
    <div class="container">
        <div class="row">
            <div class="col">
                <nav class="navbar navbar-dark navbar-expand-lg">
                    <a class="navbar-brand nav-link active" href="http://cayenne.apache.org/">Apache Cayenne</a>

                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav mr-auto">
                            
                            <li class="nav-item">
                                <a class="nav-link" href="/download/">DOWNLOAD</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="/docs/">DOCUMENTATION</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="/about/support/">SUPPORT</a>
                            </li>
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</header>








<div class="container">
    <div class="row">
        <div class="col-3">
            <div role="tabpanel">
                <ul class="nav" role="tablist">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                            Cayenne Version 3.0
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" id="cayenne-4-1-tab" href="#cayenne-4-1" role="tab" data-toggle="tab" aria-controls="cayenne-4-1" aria-expanded="true">Version 4.1 (Alpha)</a>
                            <a class="dropdown-item" id="cayenne-4-0-tab" href="#cayenne-4-0" role="tab" data-toggle="tab" aria-controls="cayenne-4-0" aria-expanded="true">Version 4.0 (Beta)</a>
                            <a class="dropdown-item" id="cayenne-3-1-tab" href="#cayenne-3-1" role="tab" data-toggle="tab" aria-controls="cayenne-3-1" aria-expanded="true">Version 3.1 (Stable)</a>
                            <a class="dropdown-item" id="cayenne-3-0-tab" href="#cayenne-3-0" role="tab" data-toggle="tab" aria-controls="cayenne-3-0" aria-expanded="true">Version 3.0 (Stable)</a>
                        </div>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    
                    <div class="tab-pane fade " id="cayenne-4-1" role="tabpanel" aria-labelledby="cayenne-4-1-tab" aria-expanded="false">
                        
                        <li>
                            <h6><a href="/docs/4.1/getting-started-db-first/">Cayenne Database First tutorial</a></h6>
                        </li>
                        
                        <li>
                            <h6><a href="/docs/4.1/getting-started/">Cayenne Getting Started Guide</a></h6>
                        </li>
                        
                        <li>
                            <h6><a href="/docs/4.1/api/">JavaDoc</a></h6>
                        </li>
                    </div>
                    <div class="tab-pane fade " id="cayenne-4-0" role="tabpanel" aria-labelledby="cayenne-4-0-tab" aria-expanded="false">
                        
                        <li>
                            <h6><a href="/docs/4.0/getting-started/">Cayenne 4.0 Getting Started Guide</a></h6>
                        </li>
                        
                        <li>
                            <h6><a href="/docs/4.0/api/">JavaDoc</a></h6>
                        </li>
                    </div>
                    <div class="tab-pane fade " id="cayenne-3-1" role="tabpanel" aria-labelledby="cayenne-3-1-tab" aria-expanded="false">
                        
                        <li>
                            <h6><a href="/docs/3.1/api/">JavaDoc</a></h6>
                        </li>
                    </div>
                    <div class="tab-pane fade active show" id="cayenne-3-0" role="tabpanel" aria-labelledby="cayenne-3-0-tab" aria-expanded="true">
                        
                        <li>
                            <h6><a href="/docs/3.0/cayenne-guide.html">Cayenne Guide</a></h6>
                        </li>
                        
                        <li>
                            <h6><a href="/docs/3.0/modeler-guide.html">Modeler Guide</a></h6>
                        </li>
                        
                        <li>
                            <h6><a href="/docs/3.0/remote-object-persistence-guide.html">Remote Object Persistence Guide</a></h6>
                        </li>
                        
                        <li>
                            <h6><a href="/docs/3.0/api/">JavaDoc</a></h6>
                        </li>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-9">

            
            <article>
                <section>
                    <H2>DataObject State Management</H2>
	<P>Arguably the second most important function of DataContext (first is performing queries) is keeping track of changes made to the registered DataObjects. &quot;Registered&quot; is a keyword here - registering an object with DataContext is what gives this object its persistent qualities.</P>

<H3><A name="DataObjectStateManagement-HowtoRegisteraDataObject"></A>How to Register a DataObject</H3>

<P>Behind the scenes &quot;registering an object&quot; results in storing this object in a map using its ObjectId as a key, setting &quot;dataContext&quot; property of a DataObject to the current DataContext, and taking a snapshot of all persistent properties to be able to track later modifications. Objects can become &quot;registered&quot; in two ways:</P>

<UL>
	<LI>automatically when they are fetched via query API</LI>
	<LI>explicitly for the newly created objects</LI>
</UL>


<P>Whenever a selecting query is executed by a DataContext, all fetched objects are automatically registered with this DataContext. On the other hand, newly created objects must be registered explicitly:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-keyword">import</SPAN> org.apache.cayenne.access.DataContext;
...
DataContext context; <SPAN class="code-comment">// assume <SPAN class="code-keyword">this</SPAN> exists
</SPAN>
Artist artist = <SPAN class="code-keyword">new</SPAN> Artist();
context.registerNewObject(artist);

<SPAN class="code-comment">// after the line above is executed, artist object acquired <SPAN class="code-quote">&quot;persistent&quot;</SPAN> behavior
</SPAN><SPAN class="code-comment">// and is said to be <SPAN class="code-quote">&quot;managed&quot;</SPAN> by DataContext</SPAN></PRE>
</DIV></DIV>

<P>This code can be simplified - object creation and registrations steps can be combined in one method call:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-keyword">import</SPAN> org.apache.cayenne.access.DataContext;
...
DataContext context; <SPAN class="code-comment">// assume <SPAN class="code-keyword">this</SPAN> exists
</SPAN>
Artist artist = (Artist) context.newObject(Artist.class);</PRE>
</DIV></DIV>

<P>This method relies on the presence of a no-argument constructor in the DataObject class.</P>

<H3><A name="DataObjectStateManagement-CheckingtheStateofRegisteredDataObjects"></A>Checking the State of Registered DataObjects</H3>

<P>State transitions of DataObjects from persistence point of view are discussed in the &quot;Design&quot; chapter. State of each individual object is described by an integer constant obtained via a call to DataObject.getPeristenceState(). Allowed states are defined as static variables in PersistenceState class.</P>

<P>When a new object is inserted to the DataContext as described above, it becomes &quot;NEW&quot;:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-keyword">import</SPAN> org.apache.cayenne.access.DataContext;
...
DataContext context; <SPAN class="code-comment">// assume <SPAN class="code-keyword">this</SPAN> exists
</SPAN>
<SPAN class="code-comment">// artist will become PersistenceState.NEW
</SPAN>Artist artist = (Artist) context.newObject(Artist.class);</PRE>
</DIV></DIV>

<P>When a DataContext is committed, such object becomes &quot;COMMITTED&quot;:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-comment">// artist will become PersistenceState.COMMITTED
</SPAN>context.commitChanges();</PRE>
</DIV></DIV>

<P>When any of the attributes or relationships of the fetched or committed object are changed, such an object becomes MODIFIED:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-comment">// <SPAN class="code-keyword">this</SPAN> will change the object state to PersistenceState.MODIFIED
</SPAN>artist.setName(<SPAN class="code-quote">&quot;NewName&quot;</SPAN>);</PRE>
</DIV></DIV>

<P>When a fetched or committed object is explicitly deleted from the DataContext, object becomes DELETED:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-comment">// <SPAN class="code-keyword">this</SPAN> will change the object state to PersistenceState.DELETED
</SPAN>context.deleteObject(artist);</PRE>
</DIV></DIV>

<P>DataContext is said to have changes if it has one or more registered objects in a state PersistenceState.MODIFIED, PersistenceState.NEW or PersistenceState.DELETED. DataContext provides the following method to check if it has any changed objects:</P>

<UL>
	<LI><TT>public boolean hasChanges()</TT></LI>
</UL>


<P>There is also a way to obtain a list of changed objects in each one of the above states:</P>

<UL>
	<LI><TT>public java.util.Collection newObjects()</TT></LI>
	<LI><TT>public java.util.Collection deletedObjects()</TT></LI>
	<LI><TT>public java.util.Collection modifiedObjects()</TT></LI>
</UL>


<H3><A name="DataObjectStateManagement-SavingAllUncommittedDataObjects"></A>Saving All Uncommitted DataObjects</H3>

<P>All of the uncommitted objects (&quot;uncommitted&quot; means &quot;new&quot;, &quot;modified&quot; or &quot;deleted&quot;) are saved (&quot;committed&quot;) to the database with a single method call on the DataContext:</P>

<UL>
	<LI><TT>public void commitChanges()</TT></LI>
</UL>


<P>Method commitChanges takes care of building correct SQL statements, generating primary keys and transactional behaviour. It roughly follows this scenario:</P>

<UL>
	<LI>Checks if there are any changed objects (also detecting &quot;phantom&quot; modifications, e.g. if an object property was &quot;updated&quot; with the equivalent value).</LI>
	<LI>Validates &quot;dirty&quot; objects (for more information on validation see <A href="dataobject-validation.html" title="DataObject Validation">this page</A>).</LI>
	<LI>Generates primary keys for any NEW objects that require autogenerated key.</LI>
	<LI>Builds any needed INSERT, UPDATE, DELETE queries.</LI>
	<LI>Starts the database transaction.</LI>
	<LI>Runs the queries.</LI>
	<LI>Commits transaction.</LI>
	<LI>Changes all committed objects state to PersistenceState.COMMITTED.</LI>
	<LI>Updates internally stored snapshots of the recently saved objects.</LI>
</UL>



<H3><A name="DataObjectStateManagement-UndoingAllUncommittedChanges"></A>Undoing All Uncommitted Changes</H3>

<P>There is a way for the DataContext to undo all uncommitted changes:</P>

<UL>
	<LI><TT>public void rollbackChanges()</TT></LI>
</UL>


<P>This will restore the persistence state and the values of all registered objects to the values that objects had when they were fetched or the last commitChanges was executed. This effectively restores previously committed state of the object graph. Note that any NEW objects are unregistered from the context.</P>

                </section>
            </article>

        </div>
    </div>
</div>

<footer class="page-footer">
    <div class="container">
        <div class="row">
            
            <div class="col">
                <h3 class="footer">About</h3>
                <ul class="list-unstyled">
                    
                    <li><a href="/why-cayenne.html" class="footer">Why Cayenne?</a>
                    
                    <li><a href="/download/" class="footer">Download</a>
                    
                    <li><a href="/success-stories.html" class="footer">Success Stories</a>
                    
                    <li><a href="/about/support/" class="footer">Support</a>
                    
                </ul>
            </div>
            
            <div class="col">
                <h3 class="footer">Documentation</h3>
                <ul class="list-unstyled">
                    
                    <li><a href="/docs/4.1/getting-started/" class="footer">Getting Started (4.1)</a>
                    
                    <li><a href="/docs/4.0/getting-started/" class="footer">Getting Started (4.0)</a>
                    
                    <li><a href="/docs/4.1/getting-started-db-first/" class="footer">Database First tutorial (4.1)</a>
                    
                </ul>
            </div>
            
            <div class="col">
                <h3 class="footer">Collaboration</h3>
                <ul class="list-unstyled">
                    
                    <li><a href="https://issues.apache.org/jira/browse/CAY" class="footer">Bug/Feature Tracker</a>
                    
                    <li><a href="/mailing-lists.html" class="footer">Mailing Lists</a>
                    
                    <li><a href="/dev/code-repository.html" class="footer">Code Repository</a>
                    
                    <li><a href="/dev/" class="footer">Developer Guide</a>
                    
                    <li><a href="/how-can-i-help.html" class="footer">How can I help?</a>
                    
                    <li><a href="/contributors.html" class="footer">Contributors</a>
                    
                </ul>
            </div>
            
            <div class="col">
                <h3 class="footer">News</h3>
                <ul class="list-unstyled">
                    
                    <li>
                        <div>
                            <small class="text-muted">Nov 20, 2017</small>
                        </div>
                        <a href="/2017/11/cayenne-312-released.html" class="footer">Cayenne 3.1.2 Released</a>
                    </li>
                    
                    <li>
                        <div>
                            <small class="text-muted">Oct 14, 2017</small>
                        </div>
                        <a href="/2017/10/cayenne-41m1-released.html" class="footer">Cayenne 4.1 Milestone 1 Released</a>
                    </li>
                    
                    <li>
                        <div>
                            <small class="text-muted">Oct 06, 2017</small>
                        </div>
                        <a href="/2017/10/cayenne-40B2-released.html" class="footer">Cayenne 4.0 Beta 2 Released</a>
                    </li>
                    
                    <li>
                        <div>
                            <small class="text-muted">Jun 12, 2017</small>
                        </div>
                        <a href="/2017/06/cayenne-40B1-released.html" class="footer">Cayenne 4.0 Beta 1 Released</a>
                    </li>
                    
                    <li>
                        <div>
                            <small class="text-muted">Mar 07, 2017</small>
                        </div>
                        <a href="/2017/03/cayenne-40M5-released.html" class="footer">Cayenne 4.0 Milestone 5 Released</a>
                    </li>
                    
                    <li><a href="http://cayenne.apache.org/news" class="footer">More news</a>
                </ul>
            </div>
        </div>
    </div>
    <hr class="footer">
    <div class="container">
        <div class="row">
            <div class="col"></div>
            <div class="col-8">
                <p class="text-center page-footer-copyright">
                    Copyright © 2001-2017 Apache Software Foundation. Apache Cayenne, Cayenne, Apache,
                    the Apache feather logo, and the Apache Cayenne project logo are trademarks of The Apache Software Foundation.
                    <a href="http://cayenne.apache.org/privacy-policy.html">Privacy policy</a>
                </p>
            </div>
            <div class="col"></div>
        </div>
    </div>
</footer>

    
    </body>
</html>
